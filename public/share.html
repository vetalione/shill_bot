<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Share PEPE - $PEPE.MP3</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            padding: 20px;
        }
        
        .container {
            text-align: center;
            max-width: 400px;
            width: 100%;
        }
        
        .pepe-logo {
            font-size: 60px;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        .loading {
            margin: 20px 0;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .fallback {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }
        
        .fallback.show {
            display: block;
        }
        
        .image-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            margin: 20px auto;
            display: block;
        }
        
        .share-text {
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            padding: 10px;
            color: white;
            width: 100%;
            font-size: 14px;
            margin: 15px 0;
            resize: vertical;
            min-height: 80px;
        }
        
        .share-text:focus {
            outline: none;
            border-color: rgba(255,255,255,0.6);
        }
        
        .button {
            background: #1da1f2;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            text-decoration: none;
            font-weight: bold;
            display: inline-block;
            margin: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .button:hover {
            background: #0d8bd9;
            transform: translateY(-2px);
        }
        
        .instructions {
            text-align: left;
            margin: 20px 0;
        }
        
        .instructions ol {
            padding-left: 20px;
        }
        
        .instructions li {
            margin: 8px 0;
            line-height: 1.4;
        }
        
        .copy-button {
            background: #10ac84;
            font-size: 12px;
            padding: 6px 12px;
        }
        
        .error {
            background: rgba(255,0,0,0.2);
            border: 1px solid rgba(255,0,0,0.5);
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            display: none;
        }
        
        .error.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="pepe-logo">üê∏</div>
        <h1>Sharing PEPE...</h1>
        <div class="loading">
            <div class="spinner"></div>
            <p>Preparing your AI-generated Pepe for sharing</p>
        </div>
        
        <div class="error" id="error">
            <h3>‚ö†Ô∏è Sharing failed</h3>
            <p id="error-message">Something went wrong. Please try manual sharing below.</p>
        </div>
        
        <div class="fallback" id="fallback">
            <h2>üì± Manual Sharing</h2>
            <img id="image-preview" class="image-preview" alt="Generated Pepe">
            
            <div class="instructions">
                <h3>üê¶ Share on Twitter:</h3>
                <ol>
                    <li><strong>Copy text:</strong>
                        <textarea id="share-text" class="share-text" readonly></textarea>
                        <button class="button copy-button" onclick="copyText()">üìã Copy Text</button>
                    </li>
                    <li><strong>Save image:</strong> Long press image above ‚Üí Save</li>
                    <li><strong>Open Twitter:</strong>
                        <a href="https://twitter.com/intent/tweet" target="_blank" class="button">üê¶ Open Twitter</a>
                    </li>
                    <li><strong>Paste & attach:</strong> Paste text + attach saved image</li>
                </ol>
            </div>
            
            <div style="margin: 20px 0;">
                <button class="button" onclick="retryNativeShare()" id="retry-button">üîÑ Try Native Share Again</button>
                <button class="button" onclick="showDebugInfo()" style="background: #6c757d; font-size: 12px;">üîç Debug Info</button>
            </div>
            
            <div id="debug-info" style="display: none; background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px; margin: 15px 0; text-align: left; font-family: monospace; font-size: 11px; max-height: 200px; overflow-y: auto;">
                <strong>Debug Information:</strong><br>
                <div id="debug-content"></div>
            </div>
        </div>
    </div>

    <script>
        let imageUrl = '';
        let shareText = '';
        let imageBlob = null;

        async function initShare() {
            try {
                // Get parameters from URL
                const urlParams = new URLSearchParams(window.location.search);
                imageUrl = urlParams.get('image');
                shareText = urlParams.get('text') || 'üê∏ Check out this AI-generated Pepe! @PEPEGOTAVOICE #TON #PepeMP3';
                
                console.log('üöÄ Initializing share with:', { 
                    imageUrl, 
                    shareText: shareText.substring(0, 50) + '...',
                    userAgent: navigator.userAgent,
                    hasNativeShare: !!navigator.share,
                    canShareCheck: navigator.canShare ? 'available' : 'not available'
                });
                
                if (!imageUrl) {
                    throw new Error('No image URL provided');
                }
                
                console.log('üì• Starting share process...');
                
                // Set up preview immediately
                const preview = document.getElementById('image-preview');
                preview.src = imageUrl;
                document.getElementById('share-text').value = shareText;
                
                // Try native share without loading image blob first
                await attemptNativeShareTextOnly();
                
            } catch (error) {
                console.error('‚ùå Share initialization failed:', error);
                showError(`Failed to initialize sharing: ${error.message}`);
                showFallback();
            }
        }
        
        async function loadImage() {
            try {
                console.log('üñºÔ∏è Loading image...');
                console.log('üì° Image URL:', imageUrl);
                
                // Set up preview first (for visual feedback)
                const preview = document.getElementById('image-preview');
                preview.src = imageUrl;
                document.getElementById('share-text').value = shareText;
                
                // Try to fetch image with better error handling
                let response;
                try {
                    // Add no-cache headers to avoid cache issues
                    response = await fetch(imageUrl, {
                        method: 'GET',
                        mode: 'cors',
                        cache: 'no-cache',
                        headers: {
                            'Accept': 'image/*'
                        }
                    });
                } catch (fetchError) {
                    console.warn('‚ö†Ô∏è Direct fetch failed, trying alternative method:', fetchError);
                    
                    // Alternative: Use img element to load and convert to blob
                    return await loadImageViaElement();
                }
                
                if (!response.ok) {
                    console.error(`‚ùå Response not OK: ${response.status} ${response.statusText}`);
                    console.error('üìù Response headers:', Object.fromEntries(response.headers.entries()));
                    
                    // Try alternative method
                    return await loadImageViaElement();
                }
                
                // Check content type
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.startsWith('image/')) {
                    console.warn(`‚ö†Ô∏è Unexpected content type: ${contentType}`);
                }
                
                imageBlob = await response.blob();
                console.log('‚úÖ Image loaded via fetch:', imageBlob.type, imageBlob.size, 'bytes');
                
            } catch (error) {
                console.error('‚ùå Image loading failed:', error);
                
                // Last resort: try loading via img element
                try {
                    await loadImageViaElement();
                } catch (fallbackError) {
                    console.error('‚ùå All image loading methods failed:', fallbackError);
                    throw new Error('Image not accessible for sharing. Try manual sharing instead.');
                }
            }
        }
        
        async function loadImageViaElement() {
            return new Promise((resolve, reject) => {
                console.log('üîÑ Trying alternative image loading method...');
                
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                img.onload = function() {
                    try {
                        // Create canvas to convert image to blob
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        canvas.width = img.naturalWidth;
                        canvas.height = img.naturalHeight;
                        
                        ctx.drawImage(img, 0, 0);
                        
                        canvas.toBlob((blob) => {
                            if (blob) {
                                imageBlob = blob;
                                console.log('‚úÖ Image loaded via canvas:', blob.type, blob.size, 'bytes');
                                resolve(null);
                            } else {
                                reject(new Error('Failed to convert image to blob'));
                            }
                        }, 'image/jpeg', 0.9);
                        
                    } catch (canvasError) {
                        console.error('‚ùå Canvas conversion failed:', canvasError);
                        reject(canvasError);
                    }
                };
                
                img.onerror = function(imgError) {
                    console.error('‚ùå Image element loading failed:', imgError);
                    reject(new Error('Image failed to load'));
                };
                
                img.src = imageUrl;
            });
        }
        
        async function attemptNativeShareTextOnly() {
            if (!navigator.share) {
                console.log('üì± Native Share API not supported');
                throw new Error('Native sharing not supported on this device');
            }
            
            try {
                console.log('üì§ Attempting text-only native share...');
                
                // Try text-only share with image URL
                const shareData = {
                    title: '$PEPE.MP3 AI Generated Pepe',
                    text: shareText + '\n\nüñºÔ∏è ' + imageUrl
                };
                
                console.log('üìã Sharing data:', shareData);
                
                await navigator.share(shareData);
                
                console.log('‚úÖ Text share completed successfully');
                showSuccess('Shared successfully! Recipients can open the image link.');
                
            } catch (error) {
                console.error('‚ùå Text-only share failed:', error);
                console.error('‚ùå Error type:', error.name);
                console.error('‚ùå Error message:', error.message);
                
                if (error.name === 'AbortError') {
                    // User cancelled - just close
                    console.log('üö´ User cancelled share');
                    showSuccess('Share cancelled');
                    setTimeout(() => window.close(), 1000);
                    return;
                }
                
                if (error.name === 'NotAllowedError') {
                    throw new Error('Sharing permission denied. Please try manual sharing.');
                }
                
                // If text-only sharing fails, try to load image and share with file
                console.log('üîÑ Text sharing failed, trying to load image for file sharing...');
                await loadImage();
                await attemptNativeShare();
            }
        }
        
        async function attemptNativeShare() {
            if (!navigator.share) {
                console.log('üì± Native Share API not supported');
                throw new Error('Native sharing not supported on this device');
            }
            
            if (!imageBlob) {
                throw new Error('Image not loaded for sharing');
            }
            
            try {
                console.log('üì§ Attempting native share...');
                console.log('üñºÔ∏è Image blob:', imageBlob.type, imageBlob.size, 'bytes');
                
                // Create file object with proper MIME type
                const imageType = imageBlob.type || 'image/jpeg';
                const imageFile = new File([imageBlob], 'pepe.jpg', { 
                    type: imageType
                });
                
                console.log('üìÅ Created file:', imageFile.name, imageFile.type, imageFile.size, 'bytes');
                
                // Check if files are supported
                if (navigator.canShare) {
                    const canShareFiles = navigator.canShare({ files: [imageFile] });
                    console.log('üìã Can share files:', canShareFiles);
                    
                    if (!canShareFiles) {
                        console.log('üìÅ File sharing not supported, trying text-only');
                        // Try text-only share
                        await navigator.share({
                            title: '$PEPE.MP3 AI Generated Pepe',
                            text: shareText + '\n\nüñºÔ∏è Image available at: ' + imageUrl
                        });
                        
                        console.log('‚úÖ Text-only share completed');
                        showSuccess('Shared text! Please attach image manually from the link.');
                        return;
                    }
                }
                
                // Attempt to share with file
                await navigator.share({
                    title: '$PEPE.MP3 AI Generated Pepe',
                    text: shareText,
                    files: [imageFile]
                });
                
                console.log('‚úÖ File share completed successfully');
                showSuccess('Shared successfully!');
                
            } catch (error) {
                console.error('‚ùå Native share failed:', error);
                console.error('‚ùå Error type:', error.name);
                console.error('‚ùå Error message:', error.message);
                
                if (error.name === 'AbortError') {
                    // User cancelled - just close
                    console.log('üö´ User cancelled share');
                    showSuccess('Share cancelled');
                    setTimeout(() => window.close(), 1000);
                    return;
                }
                
                if (error.name === 'NotAllowedError') {
                    throw new Error('Sharing permission denied. Please try manual sharing.');
                }
                
                throw new Error(`Sharing failed: ${error.message}`);
            }
        }
        
        function showSuccess(message) {
            document.querySelector('.loading').innerHTML = `
                <div style="color: #10ac84; margin: 20px 0;">
                    <div style="font-size: 40px;">‚úÖ</div>
                    <h3>${message}</h3>
                    <p>Closing in 3 seconds...</p>
                </div>
            `;
            
            setTimeout(() => {
                if (window.opener) {
                    window.close();
                } else {
                    // If can't close, show instructions to close manually
                    document.querySelector('.loading').innerHTML = `
                        <div style="color: #10ac84; margin: 20px 0;">
                            <div style="font-size: 40px;">‚úÖ</div>
                            <h3>Done!</h3>
                            <p>You can close this page now.</p>
                        </div>
                    `;
                }
            }, 3000);
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error');
            document.getElementById('error-message').textContent = message;
            errorDiv.classList.add('show');
        }
        
        function showFallback() {
            document.querySelector('.loading').style.display = 'none';
            document.getElementById('fallback').classList.add('show');
        }
        
        async function copyText() {
            try {
                await navigator.clipboard.writeText(shareText);
                
                const button = document.querySelector('.copy-button');
                const originalText = button.textContent;
                button.textContent = '‚úÖ Copied!';
                button.style.background = '#10ac84';
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '#10ac84';
                }, 2000);
                
            } catch (error) {
                console.error('Copy failed:', error);
                // Fallback: select text
                document.getElementById('share-text').select();
            }
        }
        
        async function retryNativeShare() {
            document.getElementById('fallback').classList.remove('show');
            document.getElementById('error').classList.remove('show');
            document.querySelector('.loading').style.display = 'block';
            
            try {
                // First try text-only sharing
                await attemptNativeShareTextOnly();
            } catch (error) {
                showError(error.message);
                showFallback();
            }
        }
        
        function showDebugInfo() {
            const debugDiv = document.getElementById('debug-info');
            const debugContent = document.getElementById('debug-content');
            
            const debugInfo = {
                'Image URL': imageUrl,
                'Image Blob': imageBlob ? `${imageBlob.type}, ${imageBlob.size} bytes` : 'Not loaded',
                'Native Share': navigator.share ? 'Supported' : 'Not supported',
                'Can Share': navigator.canShare ? 'Available' : 'Not available',
                'User Agent': navigator.userAgent,
                'Page URL': window.location.href,
                'Timestamp': new Date().toISOString()
            };
            
            debugContent.innerHTML = Object.entries(debugInfo)
                .map(([key, value]) => `<strong>${key}:</strong> ${value}`)
                .join('<br>');
            
            debugDiv.style.display = debugDiv.style.display === 'none' ? 'block' : 'none';
        }
        
        // Auto-start when page loads
        window.addEventListener('load', initShare);
        
        // Handle page visibility for mobile browsers
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                console.log('üì± Page became visible again');
            }
        });
    </script>
</body>
</html>